<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>class Sal7711Gen::BuscarController - RDoc Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../";
  var index_rel_prefix = "../";
</script>

<script src="../js/navigation.js" defer></script>
<script src="../js/search.js" defer></script>
<script src="../js/search_index.js" defer></script>
<script src="../js/searcher.js" defer></script>
<script src="../js/darkfish.js" defer></script>

<link href="../css/fonts.css" rel="stylesheet">
<link href="../css/rdoc.css" rel="stylesheet">


<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../table_of_contents.html#pages">Pages</a>
    <a href="../table_of_contents.html#classes">Classes</a>
    <a href="../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
<div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  <p class="link"><a href="../ApplicationController.html">ApplicationController</a>
</div>

    
<div id="includes-section" class="nav-section">
  <h3>Included Modules</h3>

  <ul class="link-list">
    <li><span class="include">Sal7711Gen::Concerns::Controllers::BuscarController</span>
    <li><span class="include">ActionView::Helpers::AssetUrlHelper</span>
  </ul>
</div>

    
    
<!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    <li ><a href="#method-i-autentica_especial">#autentica_especial</a>
    <li ><a href="#method-i-autenticado_por_ip-3F">#autenticado_por_ip?</a>
    <li ><a href="#method-i-conecta_onbase">#conecta_onbase</a>
    <li ><a href="#method-i-descarga_onbase">#descarga_onbase</a>
    <li ><a href="#method-i-incregprob">#incregprob</a>
    <li ><a href="#method-i-index">#index</a>
    <li ><a href="#method-i-mostraruno_mejoratexto">#mostraruno_mejoratexto</a>
    <li ><a href="#method-i-orden_articulos">#orden_articulos</a>
    <li ><a href="#method-i-prepara_pagina_categoria">#prepara_pagina_categoria</a>
    <li ><a href="#method-i-prepara_pagina_comp">#prepara_pagina_comp</a>
    <li ><a href="#method-i-procesa_grupo">#procesa_grupo</a>
    <li ><a href="#method-i-procesa_grupo_ubicacion">#procesa_grupo_ubicacion</a>
    <li ><a href="#method-i-sincroniza_onbase">#sincroniza_onbase</a>
    <li ><a href="#method-i-sincroniza_onbase_faltantes">#sincroniza_onbase_faltantes</a>
    <li ><a href="#method-i-sincroniza_onbase_ubicacion">#sincroniza_onbase_ubicacion</a>
    <li ><a href="#method-i-verifica_categorias_onbase">#verifica_categorias_onbase</a>
    <li ><a href="#method-i-verifica_departamentos_onbase">#verifica_departamentos_onbase</a>
    <li ><a href="#method-i-verifica_fechas_onbase">#verifica_fechas_onbase</a>
    <li ><a href="#method-i-verifica_fuenteprensa_onbase">#verifica_fuenteprensa_onbase</a>
    <li ><a href="#method-i-verifica_municipios_onbase">#verifica_municipios_onbase</a>
    <li ><a href="#method-i-verifica_paginas_onbase">#verifica_paginas_onbase</a>
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-Sal7711Gen::BuscarController">
  <h1 id="class-Sal7711Gen::BuscarController" class="class">
    class Sal7711Gen::BuscarController
  </h1>

  <section class="description">
    
  </section>

  <section id="5Buntitled-5D" class="documentation-section">





     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

      <div id="method-i-autentica_especial" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">autentica_especial</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="autentica_especial-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 40</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">autentica_especial</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;OJO ipx, request=&quot;</span>, <span class="ruby-identifier">request</span>.<span class="ruby-identifier">inspect</span>;
      <span class="ruby-identifier">norgs</span> = <span class="ruby-operator">::</span><span class="ruby-constant">Organizacion</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:iporganizacion</span>).
          <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;? &lt;&lt;= ip&#39;</span>, <span class="ruby-identifier">request</span>.<span class="ruby-identifier">remote_ip</span>).<span class="ruby-identifier">count</span>
      <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">current_usuario</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">norgs</span> <span class="ruby-operator">===</span> <span class="ruby-value">0</span>
          <span class="ruby-keyword">if</span> (<span class="ruby-identifier">current_usuario</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">::</span><span class="ruby-constant">Organizacion</span>.
              <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;usuarioip_id=?&#39;</span>, <span class="ruby-identifier">current_usuario</span>.<span class="ruby-identifier">id</span>).
              <span class="ruby-identifier">count</span>(<span class="ruby-string">&#39;*&#39;</span>) <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>)
            <span class="ruby-comment"># Si la organización ya no se autentica por IP se termina</span>
            <span class="ruby-comment"># sesión de usuario</span>
            <span class="ruby-identifier">sign_out</span>(<span class="ruby-identifier">current_usuario</span>)
          <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">norgs</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
          <span class="ruby-operator">::</span><span class="ruby-constant">Ability</span><span class="ruby-operator">::</span><span class="ruby-identifier">ultimo_error_aut</span> = <span class="ruby-string">&#39;IP coincide con varias organizaciones&#39;</span>
          <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;** Error: &quot;</span>, <span class="ruby-operator">::</span><span class="ruby-constant">Ability</span><span class="ruby-operator">::</span><span class="ruby-identifier">ultimo_error_aut</span> 
          <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">org</span> = <span class="ruby-operator">::</span><span class="ruby-constant">Organizacion</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:iporganizacion</span>)
          .<span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;?&lt;&lt;=ip&#39;</span>, <span class="ruby-identifier">request</span>.<span class="ruby-identifier">remote_ip</span>).<span class="ruby-identifier">take</span>
          <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">org</span>.<span class="ruby-identifier">usuarioip_id</span>
            <span class="ruby-operator">::</span><span class="ruby-constant">Ability</span>.<span class="ruby-identifier">ultimo_error_aut</span> = <span class="ruby-string">&#39;Organización sin Usuario IP&#39;</span>
            <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;** Error: &quot;</span>, <span class="ruby-operator">::</span><span class="ruby-constant">Ability</span><span class="ruby-operator">::</span><span class="ruby-identifier">ultimo_error_aut</span> 
            <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
          <span class="ruby-keyword">end</span>
          <span class="ruby-identifier">us</span> = <span class="ruby-operator">::</span><span class="ruby-constant">Usuario</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">org</span>.<span class="ruby-identifier">usuarioip_id</span>)
          <span class="ruby-identifier">sign_in</span>(<span class="ruby-identifier">us</span>) <span class="ruby-comment">#, bypass: true#, store: false</span>
          <span class="ruby-comment">#byebug</span>
          <span class="ruby-identifier">current_usuario</span>.<span class="ruby-identifier">autenticado_por_ip</span> = <span class="ruby-keyword">true</span>
          <span class="ruby-identifier">current_usuario</span>.<span class="ruby-identifier">save!</span>
          <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>;
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
<span class="ruby-comment">#      if current_usuario &amp;&amp; current_usuario.autenticado_por_ip</span>
<span class="ruby-comment">#        if org.opciones_url_nombre_cif</span>
<span class="ruby-comment">#          Rails.configuration.action_mailer.default_url_options[:host] =</span>
<span class="ruby-comment">#            org.opciones_url_nombre_cif</span>
<span class="ruby-comment">#        end</span>
<span class="ruby-comment">#        if org.opciones_url_puerto_cif</span>
<span class="ruby-comment">#          Rails.configuration.action_mailer.default_url_options[:port] =</span>
<span class="ruby-comment">#            org.opciones_url_puerto_cif</span>
<span class="ruby-comment">#        end</span>
<span class="ruby-comment">#        if org.opciones_url_nombre_nocif</span>
<span class="ruby-comment">#          Rails.configuration.x.serv_nocif[:host] =</span>
<span class="ruby-comment">#            org.opciones_url_nombre_nocif</span>
<span class="ruby-comment">#        end</span>
<span class="ruby-comment">#        if org.opciones_url_puerto_nocif</span>
<span class="ruby-comment">#          Rails.configuration.x.serv_nocif[:port] =</span>
<span class="ruby-comment">#            org.opciones_url_puerto_nocif</span>
<span class="ruby-comment">#        end</span>
<span class="ruby-comment">#        puts &quot;Rails.configuration.action_mailer.default_url_options=&quot;,</span>
<span class="ruby-comment">#          Rails.configuration.action_mailer.default_url_options</span>
<span class="ruby-comment">#        puts &quot;Rails.configuration.x.serv_nocif=&quot;,</span>
<span class="ruby-comment">#          Rails.configuration.x.serv_nocif</span>
<span class="ruby-comment">#      end</span>
    <span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-autenticado_por_ip-3F" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">autenticado_por_ip?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          <p>skip_before_action :verify_authenticity_token, if: :autenticado_por_ip?</p>

<pre>Necesario para EZ-Proxy, por lo mismo se requiere authorize en otros métodos</pre>

          <div class="method-source-code" id="autenticado_por_ip-3F-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 12</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">autenticado_por_ip?</span>
  <span class="ruby-identifier">current_usuario</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_usuario</span>.<span class="ruby-identifier">autenticado_por_ip</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-conecta_onbase" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">conecta_onbase</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="conecta_onbase-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 99</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">conecta_onbase</span>
  <span class="ruby-comment">#if !@client || @client.dead? || !@client.active?</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@client</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@client</span>.<span class="ruby-identifier">active?</span>
    <span class="ruby-ivar">@client</span> = <span class="ruby-constant">TinyTds</span><span class="ruby-operator">::</span><span class="ruby-constant">Client</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">@@hbase</span>)
    <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-string">&quot;USE OnBase&quot;</span>).<span class="ruby-identifier">do</span>;
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">dead?</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;dead&quot;</span>
    <span class="ruby-identifier">byebug</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@client</span>.<span class="ruby-identifier">active?</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;no active&quot;</span>;
    <span class="ruby-identifier">byebug</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-descarga_onbase" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">descarga_onbase</span><span
            class="method-args">(rutaremota, prefijoruta)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="descarga_onbase-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 328</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">descarga_onbase</span>(<span class="ruby-identifier">rutaremota</span>, <span class="ruby-identifier">prefijoruta</span>)
  <span class="ruby-identifier">authorize!</span> <span class="ruby-value">:read</span>, <span class="ruby-constant">Sal7711Gen</span><span class="ruby-operator">::</span><span class="ruby-constant">Articulo</span>
  <span class="ruby-comment">#conecta_onbase</span>
  <span class="ruby-identifier">rutaconv</span> = <span class="ruby-identifier">rutaremota</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-string">&quot;\\&quot;</span>, <span class="ruby-string">&quot;/&quot;</span>)
  <span class="ruby-identifier">rlocal</span> = <span class="ruby-identifier">prefijoruta</span> <span class="ruby-operator">+</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">basename</span>(<span class="ruby-identifier">rutaconv</span>)
  <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;rutaremota=#{rutaremota}, rlocal=#{rlocal}&quot;</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-operator">!</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span> <span class="ruby-identifier">rlocal</span>)
    <span class="ruby-identifier">cmd</span>=<span class="ruby-node">&quot;smbget -o #{rlocal} -p &#39;#{ENV[&#39;CLAVE_DOMINIO&#39;]}&#39; -w #{ENV[&#39;DOMINIO&#39;]} -u #{ENV[&#39;USUARIO_DOMINIO&#39;]} -v smb://#{ENV[&#39;IP_HBASE&#39;]}/#{ENV[&#39;CARPETA&#39;]}/#{rutaconv}&quot;</span>
    <span class="ruby-identifier">cmdl</span> = <span class="ruby-identifier">cmd</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;CLAVE_DOMINIO&#39;</span>], <span class="ruby-string">&#39;*****&#39;</span>)
    <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;Ejecutando #{cmdl}&quot;</span>
    <span class="ruby-identifier">r</span>=<span class="ruby-node">`#{cmd}`</span>
    <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;Resultado: ---- #{r} ----&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">rlocal</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-incregprob" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">incregprob</span><span
            class="method-args">(itemnum)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="incregprob-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 116</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">incregprob</span>(<span class="ruby-identifier">itemnum</span>)
      <span class="ruby-ivar">@regprob</span>[<span class="ruby-identifier">itemnum</span>] = 
        <span class="ruby-ivar">@regprob</span>[<span class="ruby-identifier">itemnum</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">?</span> <span class="ruby-value">1</span> <span class="ruby-operator">:</span> 
        <span class="ruby-ivar">@regprob</span>[<span class="ruby-identifier">itemnum</span>] <span class="ruby-operator">+</span> <span class="ruby-value">1</span> 
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-index" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">index</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          <p>Resultado de aplicar filtro</p>

          <div class="method-source-code" id="index-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 867</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">index</span>
  <span class="ruby-identifier">autentica_especial</span>
  <span class="ruby-identifier">authorize!</span> <span class="ruby-value">:read</span>, <span class="ruby-constant">Sal7711Gen</span><span class="ruby-operator">::</span><span class="ruby-constant">Articulo</span>
  <span class="ruby-identifier">prepara_meses</span>
  <span class="ruby-ivar">@muestraid</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:muestraid</span>].<span class="ruby-identifier">to_i</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>.<span class="ruby-identifier">to_unsafe_h</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">2</span>
    <span class="ruby-comment"># 2 params que siempre estan son controller y action si hay</span>
    <span class="ruby-comment"># más sería una consulta iniciada por usuario</span>
    <span class="ruby-identifier">prepara_pagina</span>
    <span class="ruby-constant">Sal7711Gen</span><span class="ruby-operator">::</span><span class="ruby-constant">Bitacora</span>.<span class="ruby-identifier">a</span>( <span class="ruby-identifier">request</span>.<span class="ruby-identifier">remote_ip</span>, <span class="ruby-identifier">current_usuario</span>, 
                           <span class="ruby-string">&#39;index&#39;</span>, <span class="ruby-identifier">params</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { }
    <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">head</span> <span class="ruby-value">:no_content</span> }
    <span class="ruby-identifier">format</span>.<span class="ruby-identifier">js</span>   { <span class="ruby-identifier">render</span> <span class="ruby-string">&#39;resultados&#39;</span> }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-mostraruno_mejoratexto" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">mostraruno_mejoratexto</span><span
            class="method-args">(texto, params)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="mostraruno_mejoratexto-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 861</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mostraruno_mejoratexto</span>(<span class="ruby-identifier">texto</span>, <span class="ruby-identifier">params</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">texto</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-orden_articulos" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">orden_articulos</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="orden_articulos-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 36</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">orden_articulos</span>
  <span class="ruby-string">&quot;fecha, adjunto_descripcion&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-prepara_pagina_categoria" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">prepara_pagina_categoria</span><span
            class="method-args">(articulos, ccat)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          <p>Forma de buscar categorias</p>

          <div class="method-source-code" id="prepara_pagina_categoria-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 835</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">prepara_pagina_categoria</span>(<span class="ruby-identifier">articulos</span>, <span class="ruby-identifier">ccat</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">ccat</span>.<span class="ruby-identifier">ends_with?</span> <span class="ruby-string">&quot;*&quot;</span>
    <span class="ruby-identifier">op</span> = <span class="ruby-string">&#39; LIKE &#39;</span>
    <span class="ruby-identifier">cod</span> = <span class="ruby-node">&quot;#{ccat.split(&#39;*&#39;)[0]}%&quot;</span>
  <span class="ruby-keyword">else</span> 
    <span class="ruby-identifier">cat</span> = <span class="ruby-constant">Sal7711Gen</span><span class="ruby-operator">::</span><span class="ruby-constant">Categoriaprensa</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">codigo:</span> <span class="ruby-identifier">ccat</span>).<span class="ruby-identifier">take</span>;
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">cat</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">cat</span>.<span class="ruby-identifier">supracategoria</span>
      <span class="ruby-identifier">op</span> = <span class="ruby-string">&#39; LIKE &#39;</span>
      <span class="ruby-identifier">cod</span> = <span class="ruby-node">&quot;#{cat.codigo}%&quot;</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">cat</span>
      <span class="ruby-identifier">op</span> = <span class="ruby-string">&#39; = &#39;</span>
      <span class="ruby-identifier">cod</span> = <span class="ruby-identifier">cat</span>.<span class="ruby-identifier">codigo</span>.<span class="ruby-identifier">to_s</span>
    <span class="ruby-keyword">else</span>
     <span class="ruby-identifier">op</span> = <span class="ruby-string">&#39; LIKE &#39;</span>
     <span class="ruby-identifier">cod</span> = <span class="ruby-node">&quot;#{ccat}%&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">articulos</span> = <span class="ruby-identifier">articulos</span>.<span class="ruby-identifier">where</span>(<span class="ruby-node">&quot;id IN (SELECT articulo_id FROM
    public.sal7711_gen_articulo_categoriaprensa INNER JOIN 
    public.sal7711_gen_categoriaprensa ON 
    sal7711_gen_categoriaprensa.id = sal7711_gen_articulo_categoriaprensa.categoriaprensa_id 
    WHERE codigo #{op} ?)&quot;</span>, <span class="ruby-identifier">cod</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">articulos</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-prepara_pagina_comp" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">prepara_pagina_comp</span><span
            class="method-args">(articulos, params)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="prepara_pagina_comp-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 821</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">prepara_pagina_comp</span>(<span class="ruby-identifier">articulos</span>, <span class="ruby-identifier">params</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:buscar</span>][<span class="ruby-value">:textob</span>]  <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:buscar</span>][<span class="ruby-value">:textob</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">&#39;&#39;</span>
    <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">available_locales</span> = [<span class="ruby-value">:es</span>]
    <span class="ruby-identifier">t</span> =  <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">quote</span>(
      <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">transliterate</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:buscar</span>][<span class="ruby-value">:textob</span>].<span class="ruby-identifier">downcase</span>)
    ) <span class="ruby-comment"># En ruby opera con acentos</span>
    <span class="ruby-identifier">w</span> = <span class="ruby-string">&quot;to_tsvector(&#39;spanish&#39;, f_unaccent(COALESCE(texto, &#39;&#39;))) @@ &quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;plainto_tsquery(&#39;spanish&#39;, #{t})&quot;</span>
    <span class="ruby-identifier">articulos</span> = <span class="ruby-identifier">articulos</span>.<span class="ruby-identifier">where</span>(<span class="ruby-node">&quot;#{w}&quot;</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">articulos</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-procesa_grupo" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">procesa_grupo</span><span
            class="method-args">(minitemnum, maxitemnum, grupof=[], grupoe=[])</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          <p>grupof Son los qeu faltan de [minitemnum, maxitemnum) grupoe son los que ya estan de [minitemnum, maxitemnum)</p>

          <div class="method-source-code" id="procesa_grupo-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 348</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">procesa_grupo</span>(<span class="ruby-identifier">minitemnum</span>, <span class="ruby-identifier">maxitemnum</span>, <span class="ruby-identifier">grupof</span>=[], <span class="ruby-identifier">grupoe</span>=[])
      <span class="ruby-identifier">conecta_onbase</span>
      <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@client</span>.<span class="ruby-identifier">closed?</span>
        <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">close</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-ivar">@client</span> = <span class="ruby-constant">TinyTds</span><span class="ruby-operator">::</span><span class="ruby-constant">Client</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">@@hbase</span>)
      <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-string">&quot;USE OnBase&quot;</span>).<span class="ruby-identifier">do</span>;
     
      <span class="ruby-comment"># Ya estan todos</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">grupof</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">grupoe</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
        <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;No faltan&quot;</span>
        <span class="ruby-keyword">return</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">grupof</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
        <span class="ruby-identifier">cadestan</span> = <span class="ruby-string">&quot;AND itemdata.itemnum IN (&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">grupof</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;, &#39;</span>) <span class="ruby-operator">+</span> <span class="ruby-string">&quot;)&quot;</span>
<span class="ruby-comment">#      else</span>
<span class="ruby-comment">#        consestan = &quot;SELECT onbase_itemnum FROM sal7711_gen_articulo</span>
<span class="ruby-comment">#          WHERE onbase_itemnum &lt; #{maxitemnum}</span>
<span class="ruby-comment">#          AND onbase_itemnum &gt;= #{minitemnum} ORDER BY 1&quot;</span>
<span class="ruby-comment">#          estan = ActiveRecord::Base.connection.select_all consestan</span>
<span class="ruby-comment">#          cadestan = estan.to_a.map {|v| v[&#39;onbase_itemnum&#39;]}.join(&#39;, &#39;)</span>
<span class="ruby-comment">#</span>
<span class="ruby-comment">#          if cadestan.length &gt; 0</span>
<span class="ruby-comment">#            cadestan = &quot;AND itemdata.itemnum NOT IN (&quot; + cadestan + &quot;)&quot;</span>
<span class="ruby-comment">#          end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">fbuenos</span> = <span class="ruby-node">&quot;FROM itemdata 
          JOIN itemdatapage ON itemdata.itemnum=itemdatapage.itemnum 
          JOIN keyitem103 ON keyitem103.itemnum=itemdata.itemnum   
          JOIN keyxitem101 ON keyxitem101.itemnum = itemdata.itemnum
          JOIN keytable101 ON keyxitem101.keywordnum = keytable101.keywordnum 
          JOIN keyxitem104 ON keyxitem104.itemnum = itemdata.itemnum
          JOIN keytable104  ON keyxitem104.keywordnum = keytable104.keywordnum 
          LEFT JOIN keyxitem112 ON keyxitem112.itemnum = itemdata.itemnum
          LEFT JOIN keytable112  ON keyxitem112.keywordnum = keytable112.keywordnum 
          LEFT JOIN keyxitem108 ON keyxitem108.itemnum = itemdata.itemnum
          LEFT JOIN keytable108  ON 
            keyxitem108.keywordnum = keytable108.keywordnum 
          LEFT JOIN keyxitem110 ON keyxitem110.itemnum = itemdata.itemnum
          LEFT JOIN keytable110  ON 
            keyxitem110.keywordnum = keytable110.keywordnum 
          LEFT JOIN keyxitem113 ON keyxitem113.itemnum = itemdata.itemnum
          LEFT JOIN keytable113  ON 
            keyxitem113.keywordnum = keytable113.keywordnum 
          LEFT JOIN keyxitem114 ON keyxitem114.itemnum = itemdata.itemnum
          LEFT JOIN keytable114  ON 
            keyxitem114.keywordnum = keytable114.keywordnum 
          LEFT JOIN archivedqueue ON
           itemdata.batchnum = archivedqueue.batchnum 
          WHERE keyitem103.keyvaluedate &gt;= &#39;1960-01-01&#39;
          AND keyitem103.keyvaluedate &lt;= &#39;#{Time.now.strftime(&quot;%Y-%m-%d&quot;)}&#39;
          AND itemname LIKE &#39;Prensa Cinep%&#39; &quot;</span>

      <span class="ruby-identifier">c</span>=<span class="ruby-node">&quot;SELECT itemdata.itemnum AS itemnum, itemdata.itemname AS itemname,
          itemdata.batchnum AS batchnum,
          itemdatapage.filepath AS filepath,
          keyitem103.keyvaluedate AS fecha,
          keytable101.keyvaluechar AS fuenteprensa,
          keytable104.keyvaluechar AS pagina,
          keytable108.keyvaluechar AS departamento,
          keytable110.keyvaluechar AS municipio,
          keytable112.keyvaluechar AS cat1,
          keytable113.keyvaluechar AS cat2,
          keytable114.keyvaluechar AS cat3,
          archivedqueue.batchname AS batchname
          #{fbuenos}
          AND itemdata.itemnum &lt; #{maxitemnum}
          AND itemdata.itemnum &gt;= #{minitemnum}
          #{cadestan}
          ORDER BY itemnum &quot;</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;OJO q=#{c}&quot;</span>
      <span class="ruby-identifier">numreg</span> = <span class="ruby-value">0</span>
      <span class="ruby-comment"># Resultado a colchon en memoria</span>
      <span class="ruby-identifier">colchon</span> = []
      <span class="ruby-identifier">result</span> = <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">c</span>)
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:each</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fila</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">colchon</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">fila</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">cancel</span>
      <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">close</span>

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">colchon</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
        <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;De los que faltan en base local no hay registros completos en remota&quot;</span>
        <span class="ruby-keyword">return</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Procesando colchon&quot;</span>
      <span class="ruby-comment"># Se procesa colchon</span>
      <span class="ruby-identifier">colchon</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fila</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">numreg</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
        <span class="ruby-identifier">itemnum</span> = <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;itemnum&#39;</span>]
        <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;numreg=#{numreg}, itemnum=#{itemnum}&quot;</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">grupoe</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">itemnum</span>).<span class="ruby-identifier">nil?</span>
          <span class="ruby-identifier">itemname</span> = <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;itemname&#39;</span>]
          <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;itemname #{itemname}&quot;</span>
          <span class="ruby-identifier">nart</span> = <span class="ruby-constant">Sal7711Gen</span><span class="ruby-operator">::</span><span class="ruby-constant">Articulo</span>.<span class="ruby-identifier">new</span>
          <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">nart</span>
            <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;&lt;br&gt;No pudo crearse articulo&quot;</span>
            <span class="ruby-keyword">next</span>
          <span class="ruby-keyword">end</span>
          <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">onbase_itemnum</span> = <span class="ruby-identifier">itemnum</span>
          <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">adjunto_descripcion</span> = <span class="ruby-identifier">itemname</span>
          <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">fecha</span> = <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;fecha&#39;</span>]
          <span class="ruby-comment"># Lote</span>
          <span class="ruby-identifier">nlote</span> = <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;batchnum&#39;</span>] 
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">nlote</span> 
            <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">Lote</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">nlote</span>.<span class="ruby-identifier">to_i</span>)
              <span class="ruby-identifier">l</span> = <span class="ruby-constant">Lote</span>.<span class="ruby-identifier">new</span>
              <span class="ruby-identifier">l</span>.<span class="ruby-identifier">id</span> = <span class="ruby-identifier">nlote</span>.<span class="ruby-identifier">to_i</span>
              <span class="ruby-identifier">l</span>.<span class="ruby-identifier">usuario_id</span> = <span class="ruby-identifier">current_usuario</span>.<span class="ruby-identifier">id</span>
              <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;OJO current_usuario.id=#{current_usuario.id}&quot;</span>
              <span class="ruby-identifier">l</span>.<span class="ruby-identifier">nombre</span> = <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;batchname&#39;</span>]
              <span class="ruby-identifier">l</span>.<span class="ruby-identifier">save!</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">lote_id</span> = <span class="ruby-identifier">nlote</span>
          <span class="ruby-keyword">end</span>

          <span class="ruby-comment"># Departamento</span>
          <span class="ruby-comment">#          #byebug</span>
          <span class="ruby-identifier">dep</span> = <span class="ruby-identifier">fila</span>[<span class="ruby-string">&quot;departamento&quot;</span>]
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">dep</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">dep</span>.<span class="ruby-identifier">strip</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&#39;&#39;</span>
            <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">departamento</span> = <span class="ruby-constant">Sip</span><span class="ruby-operator">::</span><span class="ruby-constant">Departamento</span>.<span class="ruby-identifier">where</span>(
              <span class="ruby-string">&quot;SUBSTRING(nombre FROM 1 FOR 45) = ?&quot;</span>, <span class="ruby-identifier">dep</span>.<span class="ruby-identifier">strip</span>).<span class="ruby-identifier">first</span>
            <span class="ruby-comment"># Municipio</span>
            <span class="ruby-identifier">mun</span>=<span class="ruby-identifier">fila</span>[<span class="ruby-string">&quot;municipio&quot;</span>]
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">mun</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">mun</span>.<span class="ruby-identifier">strip</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&#39;&#39;</span>
              <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">municipio</span> = <span class="ruby-constant">Sip</span><span class="ruby-operator">::</span><span class="ruby-constant">Municipio</span>.<span class="ruby-identifier">where</span>(
                <span class="ruby-value">id_departamento:</span> <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">departamento_id</span>).<span class="ruby-identifier">where</span>(
                  <span class="ruby-string">&quot;SUBSTRING(nombre FROM 1 FOR 45) = ?&quot;</span>, <span class="ruby-identifier">mun</span>.<span class="ruby-identifier">strip</span>).<span class="ruby-identifier">first</span>
            <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">end</span>

          <span class="ruby-comment"># Fuente de prensa</span>
          <span class="ruby-identifier">f</span> = <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;fuenteprensa&#39;</span>]
          <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">f</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">strip</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;&#39;</span>
            <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;&lt;br&gt;Elemento #{itemnum} no tiene fuente (saltando)&quot;</span>
            <span class="ruby-identifier">incregprob</span>(<span class="ruby-identifier">itemnum</span>)
            <span class="ruby-keyword">next</span>
          <span class="ruby-keyword">end</span>
          <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">fuenteprensa</span> = <span class="ruby-constant">Sip</span><span class="ruby-operator">::</span><span class="ruby-constant">Fuenteprensa</span>.<span class="ruby-identifier">where</span>(
            <span class="ruby-string">&quot;SUBSTRING(nombre FROM 1 FOR 45) = ?&quot;</span>, <span class="ruby-identifier">f</span>.<span class="ruby-identifier">strip</span>).<span class="ruby-identifier">first</span>
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">fuenteprensa</span>.<span class="ruby-identifier">nil?</span>
            <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;&lt;br&gt;Elemento #{itemnum} tiene fuente errada #{f} (saltando)&quot;</span>
            <span class="ruby-identifier">incregprob</span>(<span class="ruby-identifier">itemnum</span>)
            <span class="ruby-keyword">next</span>
          <span class="ruby-keyword">end</span>

          <span class="ruby-comment"># Pagina</span>
          <span class="ruby-identifier">p</span> = <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;pagina&#39;</span>]
          <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">p</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">strip</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;&#39;</span>
            <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;&lt;br&gt;Elemento #{itemnum} no tiene página (saltando)&quot;</span>
            <span class="ruby-identifier">incregprob</span>(<span class="ruby-identifier">itemnum</span>)
            <span class="ruby-keyword">next</span>
          <span class="ruby-keyword">end</span>
          <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">pagina</span> = <span class="ruby-identifier">p</span>

          <span class="ruby-comment"># Adjunto</span>
          <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">created_at</span> = <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">fecha</span>
          <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">updated_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>

          <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">adjunto_file_name</span> = <span class="ruby-string">&quot;J&quot;</span>
          <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">adjunto_content_type</span> = <span class="ruby-string">&quot;J&quot;</span>
          <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">adjunto_file_size</span> = <span class="ruby-value">0</span>
          <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">adjunto_updated_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
          <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">save</span>

          <span class="ruby-identifier">prefijoruta</span> = <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">root</span>.<span class="ruby-identifier">join</span>(
            <span class="ruby-string">&#39;public&#39;</span>, <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">application</span>.<span class="ruby-identifier">config</span>.<span class="ruby-identifier">x</span>.<span class="ruby-identifier">url_colchon</span>)
          <span class="ruby-identifier">rlocal</span> = <span class="ruby-identifier">descarga_onbase</span>(<span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;filepath&#39;</span>].<span class="ruby-identifier">rstrip</span>,
                                   <span class="ruby-identifier">prefijoruta</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;/&quot;</span>)

          <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">rlocal</span>)
            <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;&lt;br&gt;No pudo descargarse archivo #{rlocal}&quot;</span>
            <span class="ruby-keyword">next</span>
          <span class="ruby-keyword">end</span>
          <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">rlocal</span>, <span class="ruby-string">&quot;r&quot;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">arc</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">adjunto</span> = <span class="ruby-identifier">arc</span>
            <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">save</span>
          <span class="ruby-keyword">end</span>

          <span class="ruby-comment"># Categorias</span>
          (<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">3</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ncat</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">ccat</span> = <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;cat&#39;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">ncat</span>.<span class="ruby-identifier">to_s</span>]
            <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">ccat</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">ccat</span>.<span class="ruby-identifier">strip</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;&#39;</span>
              <span class="ruby-keyword">if</span> <span class="ruby-identifier">ncat</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
                <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;&lt;br&gt;Elemento #{itemnum} no tiene categoria 1&quot;</span>
                <span class="ruby-identifier">incregprob</span>(<span class="ruby-identifier">itemnum</span>)
              <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">else</span>
              <span class="ruby-identifier">ccat</span>.<span class="ruby-identifier">strip!</span>
              <span class="ruby-identifier">cat</span> = <span class="ruby-constant">Sal7711Gen</span><span class="ruby-operator">::</span><span class="ruby-constant">Categoriaprensa</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">codigo:</span> <span class="ruby-identifier">ccat</span>).<span class="ruby-identifier">first</span>
              <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">cat</span>
                <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;&lt;br&gt;Elemento #{itemnum} tiene categoria #{ncat} &quot;</span> <span class="ruby-operator">+</span>
                  <span class="ruby-node">&quot;errada: #{ccat} (ignorando)&quot;</span>
                <span class="ruby-identifier">incregprob</span>(<span class="ruby-identifier">itemnum</span>)
              <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">cp</span> = <span class="ruby-constant">Sal7711Gen</span><span class="ruby-operator">::</span><span class="ruby-constant">ArticuloCategoriaprensa</span>.<span class="ruby-identifier">new</span>(
                  <span class="ruby-value">articulo_id:</span> <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">categoriaprensa_id:</span> <span class="ruby-identifier">cat</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">orden:</span> <span class="ruby-identifier">ncat</span>)
                <span class="ruby-identifier">cp</span>.<span class="ruby-identifier">save</span>
              <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">end</span>

          <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">adjunto_descripcion</span> = 
            <span class="ruby-constant">Sal7711Gen</span><span class="ruby-operator">::</span><span class="ruby-constant">ArticulosController</span>.<span class="ruby-identifier">gen_descripcion_bd</span>(<span class="ruby-identifier">nart</span>)
          <span class="ruby-identifier">nart</span>.<span class="ruby-identifier">save</span>

          <span class="ruby-ivar">@sinc</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">itemname</span>
          <span class="ruby-ivar">@procesados</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-ivar">@examinados</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-comment">#conecta_onbase</span>
    <span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-procesa_grupo_ubicacion" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">procesa_grupo_ubicacion</span><span
            class="method-args">(minitemnum, maxitemnum)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="procesa_grupo_ubicacion-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 629</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">procesa_grupo_ubicacion</span>(<span class="ruby-identifier">minitemnum</span>, <span class="ruby-identifier">maxitemnum</span>)
  <span class="ruby-identifier">conecta_onbase</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@client</span>.<span class="ruby-identifier">closed?</span>
    <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">close</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-ivar">@client</span> = <span class="ruby-constant">TinyTds</span><span class="ruby-operator">::</span><span class="ruby-constant">Client</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">@@hbase</span>)
  <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-string">&quot;USE OnBase&quot;</span>).<span class="ruby-identifier">do</span>;
 
  <span class="ruby-identifier">fbuenos</span> = <span class="ruby-node">&quot;FROM itemdata 
      JOIN itemdatapage ON itemdata.itemnum=itemdatapage.itemnum 
      JOIN keyitem103 ON keyitem103.itemnum=itemdata.itemnum   
      JOIN keyxitem101 ON keyxitem101.itemnum = itemdata.itemnum
      JOIN keytable101 ON keyxitem101.keywordnum = keytable101.keywordnum 
      JOIN keyxitem104 ON keyxitem104.itemnum = itemdata.itemnum
      JOIN keytable104  ON keyxitem104.keywordnum = keytable104.keywordnum 
      LEFT JOIN keyxitem112 ON keyxitem112.itemnum = itemdata.itemnum
      LEFT JOIN keytable112  ON keyxitem112.keywordnum = keytable112.keywordnum 
      LEFT JOIN keyxitem108 ON keyxitem108.itemnum = itemdata.itemnum
      LEFT JOIN keytable108  ON 
        keyxitem108.keywordnum = keytable108.keywordnum 
      LEFT JOIN keyxitem110 ON keyxitem110.itemnum = itemdata.itemnum
      LEFT JOIN keytable110  ON 
        keyxitem110.keywordnum = keytable110.keywordnum 
      LEFT JOIN keyxitem113 ON keyxitem113.itemnum = itemdata.itemnum
      LEFT JOIN keytable113  ON 
        keyxitem113.keywordnum = keytable113.keywordnum 
      LEFT JOIN keyxitem114 ON keyxitem114.itemnum = itemdata.itemnum
      LEFT JOIN keytable114  ON 
        keyxitem114.keywordnum = keytable114.keywordnum 
      LEFT JOIN archivedqueue ON
       itemdata.batchnum = archivedqueue.batchnum 
      WHERE keyitem103.keyvaluedate &gt;= &#39;1960-01-01&#39;
      AND keyitem103.keyvaluedate &lt;= &#39;#{Time.now.strftime(&quot;%Y-%m-%d&quot;)}&#39;
      AND itemname LIKE &#39;Prensa Cinep%&#39; &quot;</span>

  <span class="ruby-identifier">c</span>=<span class="ruby-node">&quot;SELECT itemdata.itemnum AS itemnum, itemdata.itemname AS itemname,
      itemdata.batchnum AS batchnum,
      itemdatapage.filepath AS filepath,
      keyitem103.keyvaluedate AS fecha,
      keytable101.keyvaluechar AS fuenteprensa,
      keytable104.keyvaluechar AS pagina,
      keytable108.keyvaluechar AS departamento,
      keytable110.keyvaluechar AS municipio,
      keytable112.keyvaluechar AS cat1,
      keytable113.keyvaluechar AS cat2,
      keytable114.keyvaluechar AS cat3,
      archivedqueue.batchname AS batchname
      #{fbuenos}
      AND itemdata.itemnum &lt; #{maxitemnum}
      AND itemdata.itemnum &gt;= #{minitemnum}
      AND keytable108.keyvaluechar IN (&#39;QUINDIO&#39;, &#39;BOGOTÁ, D.C.&#39;)
      ORDER BY itemnum &quot;</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;OJO q=#{c}&quot;</span>
  <span class="ruby-identifier">numreg</span> = <span class="ruby-value">0</span>
  <span class="ruby-comment"># Resultado a colchon en memoria</span>
  <span class="ruby-identifier">colchon</span> = []
  <span class="ruby-identifier">result</span> = <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">c</span>)
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:each</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fila</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">colchon</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">fila</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">cancel</span>
  <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">close</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">colchon</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;De los que faltan en base local no hay registros completos en remota&quot;</span>
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Procesando colchon&quot;</span>
  <span class="ruby-comment"># Se procesa colchon</span>
  <span class="ruby-identifier">colchon</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fila</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">numreg</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-identifier">itemnum</span> = <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;itemnum&#39;</span>]
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;numreg=#{numreg}, itemnum=#{itemnum}&quot;</span>
    <span class="ruby-identifier">guardar</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-identifier">a</span> = <span class="ruby-constant">Sal7711Gen</span><span class="ruby-operator">::</span><span class="ruby-constant">Articulo</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">onbase_itemnum:</span> <span class="ruby-identifier">itemnum</span>).<span class="ruby-identifier">take</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">nil?</span> 
      <span class="ruby-identifier">prob</span> = <span class="ruby-node">&quot;&lt;br&gt;No existe en postgres artículo con itemnum=#{itemnum}&quot;</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-identifier">prob</span>
      <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">prob</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-comment"># Departamento</span>
      <span class="ruby-comment">#          #byebug</span>
      <span class="ruby-identifier">dep</span> = <span class="ruby-identifier">fila</span>[<span class="ruby-string">&quot;departamento&quot;</span>]
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">dep</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">dep</span>.<span class="ruby-identifier">strip</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&#39;&#39;</span>
        <span class="ruby-identifier">depo</span> = <span class="ruby-constant">Sip</span><span class="ruby-operator">::</span><span class="ruby-constant">Departamento</span>.<span class="ruby-identifier">where</span>(
          <span class="ruby-string">&quot;SUBSTRING(nombre FROM 1 FOR 45) = ?&quot;</span>, <span class="ruby-identifier">dep</span>.<span class="ruby-identifier">strip</span>).<span class="ruby-identifier">first</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">depo</span>.<span class="ruby-identifier">nil?</span>
          <span class="ruby-identifier">prob</span> = <span class="ruby-node">&quot;&lt;br&gt;Referencia a departamento no existente #{dep}  en #{itemnum}&quot;</span>
          <span class="ruby-identifier">puts</span> <span class="ruby-identifier">prob</span>
          <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">prob</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">departamento_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">depo</span>.<span class="ruby-identifier">id</span>
          <span class="ruby-identifier">prob</span> = <span class="ruby-node">&quot;&lt;br&gt;Diferente departamento en registro itemnum=#{itemnum}, id=#{a.id}, dep_ms=#{depo.id}, dep_pg=#{a.departamento_id}&quot;</span>
          <span class="ruby-identifier">puts</span> <span class="ruby-identifier">prob</span>
          <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">prob</span>
          <span class="ruby-identifier">a</span>.<span class="ruby-identifier">departamento_id</span> = <span class="ruby-identifier">depo</span>.<span class="ruby-identifier">id</span>
          <span class="ruby-identifier">guardar</span> = <span class="ruby-keyword">true</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-comment"># Municipio</span>
        <span class="ruby-identifier">mun</span>=<span class="ruby-identifier">fila</span>[<span class="ruby-string">&quot;municipio&quot;</span>]
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">mun</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">mun</span>.<span class="ruby-identifier">strip</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&#39;&#39;</span>
          <span class="ruby-identifier">muno</span> = <span class="ruby-constant">Sip</span><span class="ruby-operator">::</span><span class="ruby-constant">Municipio</span>.<span class="ruby-identifier">where</span>(
            <span class="ruby-value">id_departamento:</span> <span class="ruby-identifier">depo</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">where</span>(
              <span class="ruby-string">&quot;SUBSTRING(nombre FROM 1 FOR 45) = ?&quot;</span>, <span class="ruby-identifier">mun</span>.<span class="ruby-identifier">strip</span>).<span class="ruby-identifier">first</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">muno</span>.<span class="ruby-identifier">nil?</span>
              <span class="ruby-identifier">prob</span> = <span class="ruby-node">&quot;&lt;br&gt;Referencia a municipio no existente #{mun}  en #{itemnum}&quot;</span>
              <span class="ruby-identifier">puts</span> <span class="ruby-identifier">prob</span>
              <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">prob</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">municipio_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">muno</span>.<span class="ruby-identifier">id</span>
              <span class="ruby-identifier">prob</span> = <span class="ruby-node">&quot;&lt;br&gt;Diferente municipio en registro itemnum=#{itemnum}, id=#{a.id}, mun_ms=#{muno.id}, mun_pg=#{a.municipio_id}&quot;</span>
              <span class="ruby-identifier">puts</span> <span class="ruby-identifier">prob</span>
              <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">prob</span>
              <span class="ruby-identifier">a</span>.<span class="ruby-identifier">municipio_id</span> = <span class="ruby-identifier">muno</span>.<span class="ruby-identifier">id</span>
              <span class="ruby-identifier">guardar</span> = <span class="ruby-keyword">true</span>
            <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">dc</span> = <span class="ruby-constant">Sal7711Gen</span><span class="ruby-operator">::</span><span class="ruby-constant">ArticulosController</span>.<span class="ruby-identifier">gen_descripcion_bd</span>(<span class="ruby-identifier">a</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">adjunto_descripcion</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">dc</span>
        <span class="ruby-identifier">prob</span> = <span class="ruby-node">&quot;&lt;br&gt;Descripciones no coinciden itemnum=#{itemnum}, id=#{a.id}&quot;</span>
        <span class="ruby-identifier">puts</span> <span class="ruby-identifier">prob</span>
        <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">prob</span>
        <span class="ruby-identifier">a</span>.<span class="ruby-identifier">adjunto_descripcion</span> = <span class="ruby-identifier">dc</span>
        <span class="ruby-identifier">guardar</span> = <span class="ruby-keyword">true</span>
      <span class="ruby-keyword">end</span>
      
      <span class="ruby-comment">#nart.save</span>

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">guardar</span>
        <span class="ruby-identifier">a</span>.<span class="ruby-identifier">save</span>
        <span class="ruby-ivar">@modificados</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
        <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Modificado (van #{@modificados})&quot;</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-ivar">@procesados</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-ivar">@examinados</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-comment">#conecta_onbase</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-sincroniza_onbase" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">sincroniza_onbase</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="sincroniza_onbase-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 817</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sincroniza_onbase</span>
  <span class="ruby-identifier">sincroniza_onbase_faltantes</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-sincroniza_onbase_faltantes" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">sincroniza_onbase_faltantes</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="sincroniza_onbase_faltantes-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 562</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sincroniza_onbase_faltantes</span>
  <span class="ruby-ivar">@examinados</span> = <span class="ruby-value">0</span>
  <span class="ruby-ivar">@procesados</span> = <span class="ruby-value">0</span>
  <span class="ruby-ivar">@sinc</span> = []
  <span class="ruby-ivar">@cprob</span> = <span class="ruby-string">&#39;&#39;</span>
  <span class="ruby-identifier">conecta_onbase</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@client</span>.<span class="ruby-identifier">active?</span>
    <span class="ruby-identifier">conecta_onbase</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-ivar">@regprob</span> = []
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>.<span class="ruby-identifier">to_unsafe_h</span>[<span class="ruby-string">&quot;nover&quot;</span>].<span class="ruby-identifier">nil?</span>
    <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">verifica_fechas_onbase</span>
    <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">verifica_departamentos_onbase</span>
    <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">verifica_municipios_onbase</span>
    <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">verifica_fuenteprensa_onbase</span>
    <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">verifica_paginas_onbase</span>
    <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">verifica_categorias_onbase</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-ivar">@numregprob</span> = <span class="ruby-ivar">@regprob</span>.<span class="ruby-identifier">reject</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:nil?</span>).<span class="ruby-identifier">count</span>

  <span class="ruby-comment">#return</span>
  <span class="ruby-comment">#return if @cprob != &#39;&#39;</span>
  <span class="ruby-comment">#      minitemnum = Sal7711Gen::Articulo.maximum(:onbase_itemnum) || 0</span>
  <span class="ruby-comment">#      maxitemnum = 1870</span>

  <span class="ruby-comment"># No me ha funcioando</span>
  <span class="ruby-comment"># r = @client.execute(&#39;SELECT MAX(itemnum) FROM itemdata;&#39;)</span>
  <span class="ruby-comment">#maxmax = r.first[&#39;max&#39;]</span>
  <span class="ruby-identifier">maxmax</span>=<span class="ruby-value">700000</span>

  <span class="ruby-identifier">pasada</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">deltaitemnum</span> = <span class="ruby-value">1000</span>
  <span class="ruby-identifier">minitemnum</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;MINITEMNUM&#39;</span>] <span class="ruby-operator">?</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;MINITEMNUM&#39;</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">:</span> <span class="ruby-value">1</span> 
  <span class="ruby-identifier">maxitemnum</span> = <span class="ruby-identifier">minitemnum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">deltaitemnum</span>

  <span class="ruby-comment"># Al intentar toda la consulta se presentaron errores Read Failed</span>
  <span class="ruby-comment"># Tuvimos que procesar en lotes</span>
  <span class="ruby-ivar">@numexiste</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">pasada</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-identifier">cidse</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(
      <span class="ruby-node">&quot;SELECT DISTINCT onbase_itemnum FROM public.sal7711_gen_articulo WHERE
       onbase_itemnum &gt;= #{minitemnum} AND
       onbase_itemnum &lt; #{maxitemnum}
       ORDER BY 1&quot;</span>);
       <span class="ruby-identifier">idse</span> = <span class="ruby-identifier">cidse</span>.<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>[<span class="ruby-string">&#39;onbase_itemnum&#39;</span>]}
       <span class="ruby-ivar">@numexiste</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">idse</span>.<span class="ruby-identifier">length</span>
       <span class="ruby-identifier">i</span> = <span class="ruby-value">0</span>
       <span class="ruby-identifier">idsf</span> = []
       <span class="ruby-keyword">for</span> <span class="ruby-identifier">n</span> <span class="ruby-keyword">in</span> <span class="ruby-identifier">minitemnum</span><span class="ruby-operator">..</span><span class="ruby-identifier">maxitemnum</span><span class="ruby-value">-1</span>
         <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">idse</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">idse</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">n</span> <span class="ruby-keyword">then</span>
           <span class="ruby-identifier">i</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
         <span class="ruby-keyword">else</span>
           <span class="ruby-identifier">idsf</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">n</span>
         <span class="ruby-keyword">end</span>
       <span class="ruby-keyword">end</span>
       <span class="ruby-comment">#byebug</span>
       <span class="ruby-identifier">procesa_grupo</span>(<span class="ruby-identifier">minitemnum</span>, <span class="ruby-identifier">maxitemnum</span>, <span class="ruby-identifier">idsf</span>, <span class="ruby-identifier">idse</span>)
       <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">maxitemnum</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">maxmax</span>
       <span class="ruby-identifier">minitemnum</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">deltaitemnum</span>
       <span class="ruby-identifier">maxitemnum</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">deltaitemnum</span>
       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;Fin ciclo ahora minitemnum=#{minitemnum}, maxitemnum=#{maxitemnum}&quot;</span>
  <span class="ruby-keyword">end</span> <span class="ruby-comment"># loop</span>
  <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-string">&quot;Fin sincroniza_onbase&quot;</span>

<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-sincroniza_onbase_ubicacion" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">sincroniza_onbase_ubicacion</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="sincroniza_onbase_ubicacion-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 771</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sincroniza_onbase_ubicacion</span>
  <span class="ruby-ivar">@examinados</span> = <span class="ruby-value">0</span>
  <span class="ruby-ivar">@procesados</span> = <span class="ruby-value">0</span>
  <span class="ruby-ivar">@modificados</span> = <span class="ruby-value">0</span>
  <span class="ruby-ivar">@sinc</span> = []
  <span class="ruby-ivar">@cprob</span> = <span class="ruby-string">&#39;&#39;</span>
  <span class="ruby-identifier">conecta_onbase</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@client</span>.<span class="ruby-identifier">active?</span>
    <span class="ruby-identifier">conecta_onbase</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-ivar">@regprob</span> = []
  <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">verifica_departamentos_onbase</span>
  <span class="ruby-ivar">@cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">verifica_municipios_onbase</span>
  <span class="ruby-ivar">@numregprob</span> = <span class="ruby-ivar">@regprob</span>.<span class="ruby-identifier">reject</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:nil?</span>).<span class="ruby-identifier">count</span>

  <span class="ruby-comment">#return</span>
  <span class="ruby-comment">#return if @cprob != &#39;&#39;</span>
  <span class="ruby-comment">#      minitemnum = Sal7711Gen::Articulo.maximum(:onbase_itemnum) || 0</span>
  <span class="ruby-comment">#      maxitemnum = 1870</span>

  <span class="ruby-comment"># No me ha funcioando</span>
  <span class="ruby-comment"># r = @client.execute(&#39;SELECT MAX(itemnum) FROM itemdata;&#39;)</span>
  <span class="ruby-comment">#maxmax = r.first[&#39;max&#39;]</span>
  <span class="ruby-identifier">maxmax</span>=<span class="ruby-value">700000</span>
  <span class="ruby-comment">#maxmax=10000</span>

  <span class="ruby-identifier">pasada</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">deltaitemnum</span> = <span class="ruby-value">1000</span>
  <span class="ruby-identifier">minitemnum</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;MINITEMNUM&#39;</span>] <span class="ruby-operator">?</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;MINITEMNUM&#39;</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">:</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">maxitemnum</span> = <span class="ruby-identifier">minitemnum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">deltaitemnum</span>

  <span class="ruby-comment"># Al intentar toda la consulta se presentaron errores Read Failed</span>
  <span class="ruby-comment"># Tuvimos que procesar en lotes</span>
  <span class="ruby-ivar">@numexiste</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">pasada</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
       <span class="ruby-identifier">procesa_grupo_ubicacion</span>(<span class="ruby-identifier">minitemnum</span>, <span class="ruby-identifier">maxitemnum</span>)
       <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">maxitemnum</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">maxmax</span>
       <span class="ruby-identifier">minitemnum</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">deltaitemnum</span>
       <span class="ruby-identifier">maxitemnum</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">deltaitemnum</span>
       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;Fin ciclo ahora minitemnum=#{minitemnum}, maxitemnum=#{maxitemnum}&quot;</span>
  <span class="ruby-keyword">end</span> <span class="ruby-comment"># loop</span>
  <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-string">&quot;Fin sincroniza_onbase&quot;</span>

<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-verifica_categorias_onbase" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">verifica_categorias_onbase</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="verifica_categorias_onbase-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 202</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">verifica_categorias_onbase</span>
  <span class="ruby-identifier">cprob</span> = <span class="ruby-string">&#39;&#39;</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">false</span>
    <span class="ruby-identifier">c</span>=<span class="ruby-string">&quot;SELECT itemdata.itemnum, itemname FROM itemdata 
  JOIN keyitem103 ON itemdata.itemnum=keyitem103.itemnum 
  WHERE itemname LIKE &#39;Prensa Cinep%&#39; 
  AND itemdata.itemnum NOT IN (SELECT itemnum FROM keyxitem112);&quot;</span>
    <span class="ruby-identifier">r</span> = <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">c</span>)
    <span class="ruby-identifier">r</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:each</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fila</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;&lt;br&gt;Falta primera categoria en artículo #{fila[&#39;itemnum&#39;]}: #{fila[&#39;itemname&#39;]}&quot;</span>
      <span class="ruby-identifier">incregprob</span>(<span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;itemnum&#39;</span>].<span class="ruby-identifier">to_i</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">r</span>.<span class="ruby-identifier">do</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">sep</span> = <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-identifier">lcat</span> = <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-constant">Sal7711Gen</span><span class="ruby-operator">::</span><span class="ruby-constant">Categoriaprensa</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cat</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">lcat</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;#{sep}&#39;#{cat.codigo}&#39;&quot;</span>
    <span class="ruby-identifier">sep</span> = <span class="ruby-string">&quot;, &quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">c</span> = <span class="ruby-node">&quot;SELECT keyvaluechar, itemdata.itemnum, itemname 
       FROM keyxitem112
       JOIN keytable112 ON keyxitem112.keywordnum=keytable112.keywordnum
       JOIN itemdata ON itemdata.itemnum=keyxitem112.itemnum
       JOIN keyitem103 ON itemdata.itemnum=keyitem103.itemnum 
       WHERE keytable112.keyvaluechar NOT IN (#{lcat})
       ORDER BY 1;&quot;</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-identifier">c</span>
  <span class="ruby-comment">#exit 1</span>

  <span class="ruby-identifier">r</span> = <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">c</span>)
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:each</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fila</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;keyvaluechar&#39;</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;keyvaluechar&#39;</span>].<span class="ruby-identifier">strip</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&#39;&#39;</span>
      <span class="ruby-identifier">nc</span> = <span class="ruby-identifier">fila</span>[<span class="ruby-string">&quot;keyvaluechar&quot;</span>].<span class="ruby-identifier">strip</span>
      <span class="ruby-identifier">cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;&lt;br&gt;Categoria 1 #{nc} errada, en artículo #{fila[&#39;itemnum&#39;]}: #{fila[&#39;itemname&#39;]}&quot;</span>
      <span class="ruby-identifier">incregprob</span>(<span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;itemnum&#39;</span>].<span class="ruby-identifier">to_i</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">c</span> = <span class="ruby-node">&quot;SELECT keyvaluechar, itemdata.itemnum, itemname 
       FROM keyxitem113
       JOIN keytable113 ON keyxitem113.keywordnum=keytable113.keywordnum
       JOIN itemdata ON itemdata.itemnum=keyxitem113.itemnum
       JOIN keyitem103 ON itemdata.itemnum=keyitem103.itemnum 
       WHERE keytable113.keyvaluechar NOT IN (#{lcat})
       ORDER BY 1;&quot;</span>
  <span class="ruby-identifier">r</span> = <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">c</span>)
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:each</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fila</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;keyvaluechar&#39;</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;keyvaluechar&#39;</span>].<span class="ruby-identifier">strip</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&#39;&#39;</span>
      <span class="ruby-identifier">nc</span> = <span class="ruby-identifier">fila</span>[<span class="ruby-string">&quot;keyvaluechar&quot;</span>].<span class="ruby-identifier">strip</span>
      <span class="ruby-identifier">cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;&lt;br&gt;Categoria 2 #{nc} errada, en artículo #{fila[&#39;itemnum&#39;]}: #{fila[&#39;itemname&#39;]}&quot;</span>
      <span class="ruby-identifier">incregprob</span>(<span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;itemnum&#39;</span>].<span class="ruby-identifier">to_i</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">c</span> = <span class="ruby-node">&quot;SELECT keyvaluechar, itemdata.itemnum, itemname 
       FROM keyxitem114
       JOIN keytable114 ON keyxitem114.keywordnum=keytable114.keywordnum
       JOIN itemdata ON itemdata.itemnum=keyxitem114.itemnum
       JOIN keyitem103 ON itemdata.itemnum=keyitem103.itemnum 
       WHERE keytable114.keyvaluechar NOT IN (#{lcat})
       ORDER BY 1;&quot;</span>
  <span class="ruby-identifier">r</span> = <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">c</span>)
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:each</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fila</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;keyvaluechar&#39;</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;keyvaluechar&#39;</span>].<span class="ruby-identifier">strip</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&#39;&#39;</span>
      <span class="ruby-identifier">nc</span> = <span class="ruby-identifier">fila</span>[<span class="ruby-string">&quot;keyvaluechar&quot;</span>].<span class="ruby-identifier">strip</span>
      <span class="ruby-identifier">cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;&lt;br&gt;Categoria 3 #{nc} errada, en artículo #{fila[&#39;itemnum&#39;]}: #{fila[&#39;itemname&#39;]}&quot;</span>
      <span class="ruby-identifier">incregprob</span>(<span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;itemnum&#39;</span>].<span class="ruby-identifier">to_i</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">cprob</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-verifica_departamentos_onbase" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">verifica_departamentos_onbase</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="verifica_departamentos_onbase-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 277</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">verifica_departamentos_onbase</span>
  <span class="ruby-identifier">cprob</span> = <span class="ruby-string">&#39;&#39;</span>
  <span class="ruby-identifier">ds</span> = <span class="ruby-constant">Sip</span><span class="ruby-operator">::</span><span class="ruby-constant">Departamento</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id_pais:</span> <span class="ruby-constant">Sip</span>.<span class="ruby-identifier">paisomision</span>).
    <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;nombre != &#39;EXTERIOR&#39;&quot;</span>)
  <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-identifier">d</span>.<span class="ruby-identifier">nombre</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">44</span>]
    <span class="ruby-identifier">c</span>=<span class="ruby-node">&quot;SELECT COUNT(*) AS cuenta FROM keytable108 WHERE keyvaluechar=&#39;#{d.nombre[0..44]}&#39;;&quot;</span>
    <span class="ruby-identifier">cuentar</span> = <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">c</span>)
    <span class="ruby-ivar">@numregistros</span> = <span class="ruby-identifier">cuentar</span>.<span class="ruby-identifier">first</span>[<span class="ruby-string">&quot;cuenta&quot;</span>]
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@numregistros</span> <span class="ruby-operator">!=</span> <span class="ruby-value">1</span>
      <span class="ruby-identifier">prob</span> = <span class="ruby-node">&quot;&lt;br&gt;Departamento #{d.nombre} aparece #{@numregistros} veces&quot;</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-identifier">prob</span>
      <span class="ruby-identifier">cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">prob</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">c</span>=<span class="ruby-string">&quot;SELECT keyvaluechar FROM keytable108;&quot;</span>
  <span class="ruby-identifier">r</span> = <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">c</span>)
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:each</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fila</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;keyvaluechar&#39;</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;keyvaluechar&#39;</span>].<span class="ruby-identifier">strip</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&#39;&#39;</span>
      <span class="ruby-identifier">nd</span> = <span class="ruby-identifier">fila</span>[<span class="ruby-string">&quot;keyvaluechar&quot;</span>].<span class="ruby-identifier">strip</span>
      <span class="ruby-keyword">if</span> <span class="ruby-constant">Sip</span><span class="ruby-operator">::</span><span class="ruby-constant">Departamento</span>.
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;SUBSTRING(nombre FROM 1 FOR 45) = ?&quot;</span>, <span class="ruby-identifier">nd</span>).<span class="ruby-identifier">count</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
        <span class="ruby-identifier">prob</span> = <span class="ruby-node">&quot;&lt;br&gt;Departamento #{nd} de SQL Server no aparece en PostgreSQL&quot;</span>
        <span class="ruby-identifier">puts</span> <span class="ruby-identifier">prob</span>
        <span class="ruby-identifier">cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">prob</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">cprob</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-verifica_fechas_onbase" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">verifica_fechas_onbase</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="verifica_fechas_onbase-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 122</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">verifica_fechas_onbase</span>
  <span class="ruby-identifier">cprob</span> = <span class="ruby-string">&#39;&#39;</span>
  
  <span class="ruby-comment"># Estas por lo visto saca articulos usados internamente por</span>
  <span class="ruby-comment"># ONBASE para indexar, y no se convierten</span>
  <span class="ruby-comment">#c=&quot;SELECT itemnum, itemname FROM itemdata</span>
  <span class="ruby-comment">#WHERE itemname LIKE &#39;Prensa Cinep%&#39;</span>
  <span class="ruby-comment">#AND itemnum NOT IN (SELECT itemnum FROM keyitem103);&quot;</span>
  <span class="ruby-comment">#r = @client.execute(c)</span>
  <span class="ruby-comment">#r.try(:each) do |fila|</span>
  <span class="ruby-comment">#    cprob += &quot;&lt;br&gt;Falta fecha en artículo #{fila[&#39;itemnum&#39;]}: #{fila[&#39;itemname&#39;]}&quot;</span>
  <span class="ruby-comment">#end</span>
  <span class="ruby-comment">#r.do</span>
  <span class="ruby-identifier">c</span>=<span class="ruby-string">&quot;SELECT itemdata.itemnum, itemdata.itemname FROM itemdata 
  JOIN keyitem103 ON itemdata.itemnum=keyitem103.itemnum 
  WHERE keyitem103.keyvaluedate&lt;&#39;1960-01-01&#39;;&quot;</span>
  <span class="ruby-identifier">r</span> = <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">c</span>)
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:each</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fila</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;&lt;br&gt;Fecha muy antigua en artículo #{fila[&#39;itemnum&#39;]}: #{fila[&#39;itemname&#39;]}&quot;</span>
      <span class="ruby-identifier">incregprob</span>(<span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;itemnum&#39;</span>].<span class="ruby-identifier">to_i</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">do</span>
  <span class="ruby-identifier">c</span>=<span class="ruby-node">&quot;SELECT itemdata.itemnum, itemdata.itemname FROM itemdata 
  JOIN keyitem103 ON itemdata.itemnum=keyitem103.itemnum 
  WHERE keyitem103.keyvaluedate&gt;&#39;#{Time.now.strftime(&quot;%Y/%m/%d&quot;)}&#39;;&quot;</span>
  <span class="ruby-identifier">r</span> = <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">c</span>)
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:each</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fila</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;&lt;br&gt;Fecha en el futuro en artículo #{fila[&#39;itemnum&#39;]}: #{fila[&#39;itemname&#39;]}&quot;</span>
      <span class="ruby-identifier">incregprob</span>(<span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;itemnum&#39;</span>].<span class="ruby-identifier">to_i</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">do</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">cprob</span> 
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-verifica_fuenteprensa_onbase" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">verifica_fuenteprensa_onbase</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="verifica_fuenteprensa_onbase-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 157</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">verifica_fuenteprensa_onbase</span>
  <span class="ruby-identifier">cprob</span> = <span class="ruby-string">&#39;&#39;</span>
  <span class="ruby-identifier">c</span>=<span class="ruby-string">&quot;SELECT itemdata.itemnum, itemname FROM itemdata 
  JOIN keyitem103 ON itemdata.itemnum=keyitem103.itemnum 
  WHERE itemname LIKE &#39;Prensa Cinep%&#39; 
  AND itemdata.itemnum NOT IN (SELECT itemnum FROM keyxitem101);&quot;</span>
  <span class="ruby-identifier">r</span> = <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">c</span>)
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:each</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fila</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;&lt;br&gt;Falta fuente en artículo #{fila[&#39;itemnum&#39;]}: #{fila[&#39;itemname&#39;]}&quot;</span>
      <span class="ruby-identifier">incregprob</span>(<span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;itemnum&#39;</span>].<span class="ruby-identifier">to_i</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">do</span>

  <span class="ruby-identifier">c</span>=<span class="ruby-string">&quot;SELECT DISTINCT keyvaluechar FROM keytable101;&quot;</span>
  <span class="ruby-identifier">r</span> = <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">c</span>)
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:each</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fila</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;keyvaluechar&#39;</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;keyvaluechar&#39;</span>].<span class="ruby-identifier">strip</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&#39;&#39;</span>
      <span class="ruby-identifier">nf</span> = <span class="ruby-identifier">fila</span>[<span class="ruby-string">&quot;keyvaluechar&quot;</span>].<span class="ruby-identifier">strip</span>
      <span class="ruby-keyword">if</span> <span class="ruby-constant">Sip</span><span class="ruby-operator">::</span><span class="ruby-constant">Fuenteprensa</span>.
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;SUBSTRING(nombre FROM 1 FOR 45) = ?&quot;</span>, <span class="ruby-identifier">nf</span>).<span class="ruby-identifier">count</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
        <span class="ruby-identifier">cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;&lt;br&gt;Fuente #{nf} de SQL Server no aparece en PostgreSQL&quot;</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>


  <span class="ruby-keyword">return</span> <span class="ruby-identifier">cprob</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-verifica_municipios_onbase" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">verifica_municipios_onbase</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="verifica_municipios_onbase-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 309</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">verifica_municipios_onbase</span>
  <span class="ruby-identifier">cprob</span> = <span class="ruby-string">&#39;&#39;</span>
  <span class="ruby-identifier">c</span>=<span class="ruby-string">&quot;SELECT keyvaluechar FROM keytable110;&quot;</span>
  <span class="ruby-identifier">r</span> = <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">c</span>)
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:each</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fila</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;keyvaluechar&#39;</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;keyvaluechar&#39;</span>].<span class="ruby-identifier">strip</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&#39;&#39;</span>
      <span class="ruby-identifier">nd</span> = <span class="ruby-identifier">fila</span>[<span class="ruby-string">&quot;keyvaluechar&quot;</span>].<span class="ruby-identifier">strip</span>
      <span class="ruby-keyword">if</span> <span class="ruby-constant">Sip</span><span class="ruby-operator">::</span><span class="ruby-constant">Municipio</span>.
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;SUBSTRING(nombre FROM 1 FOR 45) = ?&quot;</span>, <span class="ruby-identifier">nd</span>).<span class="ruby-identifier">count</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
        <span class="ruby-identifier">prob</span> = <span class="ruby-node">&quot;&lt;br&gt;Municipio #{nd} de SQL Server no aparece en PostgreSQL&quot;</span>
        <span class="ruby-identifier">puts</span> <span class="ruby-identifier">prob</span>
        <span class="ruby-identifier">cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">prob</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">cprob</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-verifica_paginas_onbase" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">verifica_paginas_onbase</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          

          <div class="method-source-code" id="verifica_paginas_onbase-source">
            <pre><span class="ruby-comment"># File app/controllers/sal7711_gen/buscar_controller.rb, line 186</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">verifica_paginas_onbase</span>
  <span class="ruby-identifier">cprob</span> = <span class="ruby-string">&#39;&#39;</span>
  <span class="ruby-identifier">c</span>=<span class="ruby-string">&quot;SELECT itemdata.itemnum, itemname FROM itemdata 
  JOIN keyitem103 ON itemdata.itemnum=keyitem103.itemnum 
  WHERE itemname LIKE &#39;Prensa Cinep%&#39; 
  AND itemdata.itemnum NOT IN (SELECT itemnum FROM keyxitem104);&quot;</span>
  <span class="ruby-identifier">r</span> = <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">c</span>)
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:each</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fila</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">cprob</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;&lt;br&gt;Falta página en artículo #{fila[&#39;itemnum&#39;]}: #{fila[&#39;itemname&#39;]}&quot;</span>
      <span class="ruby-identifier">incregprob</span>(<span class="ruby-identifier">fila</span>[<span class="ruby-string">&#39;itemnum&#39;</span>].<span class="ruby-identifier">to_i</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">do</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">cprob</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

    </section>

  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.3.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

